<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Equity Market Companies</title>
    <style>
      body {
        font-family: Arial;
        margin: 20px;
        background: #f5f5f5;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
      }
      .search-box {
        padding: 20px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      input {
        width: 70%;
        padding: 10px;
        font-size: 16px;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-right: 10px;
      }
      button {
        padding: 10px 20px;
        background: #2c3e50;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      button:hover {
        background: #34495e;
      }
      .stock-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        overflow: hidden;
      }
      .stock-table th {
        background: #2c3e50;
        color: white;
        padding: 15px;
        text-align: left;
      }
      .stock-table td {
        padding: 12px 15px;
        border-bottom: 1px solid #ddd;
      }
      .stock-table tr:hover {
        background: #f8f9fa;
      }
      .positive {
        color: green;
        font-weight: bold;
      }
      .negative {
        color: red;
        font-weight: bold;
      }
      .time {
        color: #666;
        font-size: 0.9em;
      }
      #loading,
      #error {
        text-align: center;
        padding: 20px;
      }
      .json-viewer {
        line-height: 1.5;
        margin: 20px;
        border: 1px solid #ccc;
        padding: 10px;
        border-radius: 5px;
        max-width: 100%;
        overflow-x: auto;
      }
      .key {
        font-weight: bold;
        cursor: pointer;
      }
      .nested {
        margin-left: 10px;
        display: none;
      } /* Reduced indentation */
      .nested.open {
        display: block;
      }
      #searchInput2 {
        margin: 20px auto; /* Center the search box */
        padding: 5px;
        width: 250px;
        display: block;
      }
      .category,
      .sub-category,
      .item {
        margin: 2px 0;
      } /* Reduced spacing */
      .toggle-container {
        cursor: pointer;
        font-weight: bold;
        display: block;
        padding: 5px;
      }
      .key-value {
        margin: 5px 0;
      }
      ul {
        padding-left: 0; /* Removed padding from the list */
        list-style-type: none; /* Remove bullets */
      }
      li {
        display: block; /* Make each list item block-level */
      }
      .json-viewer {
        word-wrap: break-word; /* Ensure text wraps inside the container */
        white-space: pre-wrap; /* Preserve spaces and breaks */
      }
      .leaf-value {
        font-weight: normal; /* Remove bold from leaf values */
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="search-box">
        <input
          type="text"
          id="searchInput1"
          placeholder="Search for stocks..."
        />
        <button onclick="searchStocks()">Search</button>
      </div>
      <div id="loading" style="display: none">Loading...</div>
      <div id="error" style="display: none"></div>
      <table class="stock-table" id="stockTable" style="display: none">
        <thead>
          <tr>
            <th>Company</th>
            <th>LTP</th>
            <th>Change</th>
            <th>Change %</th>
            <th>Volume</th>
            <th>Last Updated</th>
          </tr>
        </thead>
        <tbody id="stockBody"></tbody>
      </table>
    </div>
    <!-- static stock text-->
    <input type="text" id="searchInput2" placeholder="Search..." />
    <div id="jsonViewer" class="json-viewer"></div>

    <script>
      const jsonData = {};
      // Recursively create the collapsible tree structure
      function createTree(data) {
        const treeContainer = document.createElement("ul");

        for (const key in data) {
          const value = data[key];
          const li = document.createElement("li");
          const isObject = typeof value === "object" && !Array.isArray(value);
          const isArray = Array.isArray(value);

          // Add collapsible behavior for nested objects/arrays
          if (isObject || isArray) {
            li.innerHTML = `<div class="toggle-container"><span class="toggle">${key}</span></div>`;
            const nestedTree = createTree(value);
            const nestedContainer = document.createElement("ul");
            nestedContainer.classList.add("nested");
            nestedContainer.appendChild(nestedTree);
            li.appendChild(nestedContainer);
          } else {
            // Display key-value pairs directly (no collapsibility for literals)
            const leafClass = "leaf-value";
            li.innerHTML = `<span class="key">${key}:</span> <span class="${leafClass}">${createLink(
              value
            )}</span>`;
          }

          treeContainer.appendChild(li);
        }

        return treeContainer;
      }

      // Function to create anchor tags for URLs
      function createLink(value) {
        if (typeof value === "string" && value.startsWith("http")) {
          return `<a href="${value}" target="_blank">${value}</a>`;
        }
        return value; // return the value as is if it's not a URL
      }

      // Toggle visibility of nested elements
      function toggleVisibility(event) {
        const toggleElement = event.target.closest(".toggle-container");
        if (toggleElement) {
          const nestedList = toggleElement.nextElementSibling;
          if (nestedList && nestedList.classList.contains("nested")) {
            nestedList.classList.toggle("open");
          }
        }
      }

      // Search functionality
      const searchInput = document.getElementById("searchInput2");
      searchInput.addEventListener("input", () => {
        const searchTerm = searchInput.value.toLowerCase();
        const filteredData = filterJSON(jsonData, searchTerm);
        renderJSON(filteredData, document.getElementById("jsonViewer"));
      });

      function filterJSON(data, searchTerm) {
        const filteredData = {};

        // Loop through data and filter based on searchTerm
        for (const key in data) {
          const value = data[key];
          if (typeof value === "object" && !Array.isArray(value)) {
            const filteredNested = filterJSON(value, searchTerm);
            if (Object.keys(filteredNested).length > 0) {
              filteredData[key] = filteredNested;
            }
          } else if (Array.isArray(value)) {
            const filteredArray = value.filter((item) => {
              return JSON.stringify(item).toLowerCase().includes(searchTerm);
            });
            if (filteredArray.length > 0) {
              filteredData[key] = filteredArray;
            }
          } else if (
            typeof value === "string" &&
            value.toLowerCase().includes(searchTerm)
          ) {
            filteredData[key] = value;
          }
        }

        return filteredData;
      }

      // Render the filtered JSON data
      function renderJSON(jsonData, container) {
        const tree = createTree(jsonData);
        container.innerHTML = ""; // Clear previous content
        container.appendChild(tree);
      }

      // Initial rendering
      document
        .getElementById("jsonViewer")
        .addEventListener("click", toggleVisibility);
      renderJSON(jsonData, document.getElementById("jsonViewer"));


      //BL Get API

      const searchInput1 = document.getElementById("searchInput1");
      const stockTable = document.getElementById("stockTable");
      const stockBody = document.getElementById("stockBody");
      const loading = document.getElementById("loading");
      const error = document.getElementById("error");

      searchInput1.addEventListener("keypress", (e) => {
        if (e.key === "Enter") searchStocks();
      });

      async function searchStocks() {
        const query = searchInput1.value.trim();
        if (!query) return;

        loading.style.display = "block";
        error.style.display = "none";
        stockTable.style.display = "none";

        try {
          const response = await fetch(
            `https://blstocks.thehindubusinessline.com/companiesinfo/search?query=${query}`
          );
          const data = await response.json();
          displayStocks(data.companiesDetails || []);
        } catch (err) {
          error.style.display = "block";
          error.textContent = "Failed to fetch stock data";
        } finally {
          loading.style.display = "none";
        }
      }

      function displayStocks(stocks) {
        if (!stocks.length) {
          error.style.display = "block";
          error.textContent = "No stocks found";
          return;
        }

        stockBody.innerHTML = stocks
          .map(
            (stock) => `
        <tr>
            <td><a href="${stock.url}" target="_blank">${stock.title}</a></td>
            <td>â‚¹${stock.LTP?.toFixed(2) || "N/A"}</td>
            <td class="${
              stock.CHANGE ? (stock.CHANGE >= 0 ? "positive" : "negative") : ""
            }">
                ${
                  stock.CHANGE
                    ? (stock.CHANGE >= 0 ? "+" : "") + stock.CHANGE.toFixed(2)
                    : "N/A"
                }
            </td>
            <td class="${
              stock.change_PERC
                ? stock.change_PERC >= 0
                  ? "positive"
                  : "negative"
                : ""
            }">
                ${
                  stock.change_PERC
                    ? (stock.change_PERC >= 0 ? "+" : "") +
                      stock.change_PERC.toFixed(2) +
                      "%"
                    : "N/A"
                }
            </td>
            <td>${stock.VOLUME?.toLocaleString() || "N/A"}</td>
            <td class="time">${
              stock.Upd_Time
                ? new Date(stock.Upd_Time).toLocaleTimeString()
                : "N/A"
            }</td>
        </tr>
    `
          )
          .join("");

        stockTable.style.display = "table";
      }
    </script>
  </body>
</html>
